This appendix presents the complete type system of Typed Lua.

\section{Subtyping rules}

\noindent

\mylabel{S-LITERAL}
\[
\senv \vdash L \subtype L
\]

\mylabel{S-FALSE}
\[
\senv \vdash \False \subtype \Boolean
\]

\mylabel{S-TRUE}
\[
\senv \vdash \True \subtype \Boolean
\]

\mylabel{S-STRING}
\[
\senv \vdash {\it string} \subtype \String
\]

\mylabel{S-INT1}
\[
\senv \vdash {\it int} \subtype \Integer
\]

\mylabel{S-INT2}
\[
\senv \vdash {\it int} \subtype \Number
\]

\mylabel{S-FLOAT}
\[
\senv \vdash {\it float} \subtype \Number
\]

\mylabel{S-BASE}
\[
\senv \vdash B \subtype B
\]

\mylabel{S-INTEGER}
\[
\senv \vdash \Integer \subtype \Number
\]

\mylabel{S-NIL}
\[
\senv \vdash \Nil \subtype \Nil
\]

\mylabel{S-VALUE}
\[
\senv \vdash F \subtype \Value
\]

\mylabel{S-ANY}
\[
\senv \vdash \Any \subtype \Any
\]

\mylabel{S-SELF}
\[
\senv \vdash \Self \subtype \Self
\]

\mylabel{S-UNION1}
\[
\dfrac{\senv \vdash F_{1} \subtype F \;\;\;
       \senv \vdash F_{2} \subtype F}
      {\senv \vdash F_{1} \cup F_{2} \subtype F}
\]

\mylabel{S-UNION2}
\[
\dfrac{\senv \vdash F \subtype F_{1}}
      {\senv \vdash F \subtype F_{1} \cup F_{2}}
\]

\mylabel{S-UNION3}
\[
\dfrac{\senv \vdash F \subtype F_{2}}
      {\senv \vdash F \subtype F_{1} \cup F_{2}}
\]

\mylabel{S-FUNCTION}
\[
\dfrac{\senv \vdash S_{3} \subtype S_{1} \;\;\;
       \senv \vdash S_{2} \subtype S_{4}}
      {\senv \vdash S_{1} \rightarrow S_{2} \subtype S_{3} \rightarrow S_{4}}
\]

\mylabel{S-PAIR}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2} \;\;\;
       \senv \vdash P_{1} \subtype P_{2}}
      {\senv \vdash F_{1} \times P_{1} \subtype F_{2} \times P_{2}}
\]

\mylabel{S-VARARG1}
\[
\dfrac{\senv \vdash F_{1} \cup \Nil \subtype F_{2} \cup \Nil}
      {\senv \vdash F_{1}{*} \subtype F_{2}{*}}
\]

\mylabel{S-VARARG2}
\[
\dfrac{\senv \vdash F_{1} \cup \Nil \subtype F_{2} \;\;\;
       \senv \vdash F_{1}{*} \subtype P_{2}}
      {\senv \vdash F_{1}{*} \subtype F_{2} \times P_{2}}
\]

\mylabel{S-VARARG3}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2} \cup \Nil \;\;\;
       \senv \vdash P_{1} \subtype F_{2}{*}}
      {\senv \vdash F_{1} \times P_{1} \subtype F_{2}{*}}
\]

\mylabel{S-UNION4}
\[
\dfrac{\senv \vdash S_{1} \subtype S \;\;\;
       \senv \vdash S_{2} \subtype S}
      {\senv \vdash S_{1} \sqcup S_{2} \subtype S}
\]

\mylabel{S-UNION5}
\[
\dfrac{\senv \vdash S \subtype S_{1}}
      {\senv \vdash S \subtype S_{1} \sqcup S_{2}}
\]

\mylabel{S-UNION6}
\[
\dfrac{\senv \vdash S \subtype S_{2}}
      {\senv \vdash S \subtype S_{1} \sqcup S_{2}}
\]

\mylabel{S-TABLE1}
\[
\dfrac{\forall i \; \exists j \;\;\;
       \senv \vdash F_{j} \subtype F_{i}' \;\;\;
       \senv \vdash F_{i}' \subtype F_{j} \;\;\;
       \senv \vdash V_{j} \subtype_{c} V_{i}'}
      {\senv \vdash \{\overline{F{:}V}\}_{fixed|closed} \subtype
                    \{\overline{F'{:}V'}\}_{closed}}
\]

\mylabel{S-TABLE2}
\[
\dfrac{\begin{array}{c}
       \forall i \; \forall j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash V_{i} \subtype_{u} V_{j}'\\
       \forall j \; \nexists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{unique} \subtype
                    \{\overline{F'{:}V'}\}_{closed}}
\]

\mylabel{S-TABLE3}
\[
\dfrac{\begin{array}{c}
       \forall i \; \exists j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \land \senv \vdash V_{i} \subtype_{u} V_{j}' \\
       \forall j \; \nexists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{unique} \subtype
                    \{\overline{F'{:}V'}\}_{unique|open|fixed}}
\]

\mylabel{S-TABLE4}
\[
\dfrac{\begin{array}{c}
       \forall i \; \forall j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \forall j \; \nexists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{open} \subtype
                    \{\overline{F'{:}V'}\}_{closed}}
\]

\mylabel{S-TABLE5}
\[
\dfrac{\begin{array}{c}
       \forall i \; \exists j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \land \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \forall j \; \nexists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \to \senv \vdash \Nil \subtype_{o} V_{j}'
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{open} \subtype
                    \{\overline{F'{:}V'}\}_{open|fixed}}
\]

\mylabel{S-TABLE6}
\[
\dfrac{\begin{array}{c}
       \forall i \; \exists j \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \;\;\;
       \senv \vdash F_{j}' \subtype F_{i} \;\;\;
       \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \forall j \; \exists i \;\;\;
       \senv \vdash F_{i} \subtype F_{j}' \;\;\;
       \senv \vdash F_{j}' \subtype F_{i} \;\;\;
       \senv \vdash V_{i} \subtype_{c} V_{j}' \\
       \end{array}}
      {\senv \vdash \{\overline{F{:}V}\}_{fixed} \subtype
                    \{\overline{F'{:}V'}\}_{fixed}}
\]

\mylabel{S-FIELD1}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2} \;\;\;
       \senv \vdash F_{2} \subtype F_{1}}
      {\senv \vdash F_{1} \subtype_{c} F_{2}}
\]

\mylabel{S-FIELD2}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash \Const \; F_{1} \subtype_{c} \Const \; F_{2}}
\]

\mylabel{S-FIELD3}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash F_{1} \subtype_{c} \Const \; F_{2}}
\]

\mylabel{S-FIELD4}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash F_{1} \subtype_{u} F_{2}}
\]

\mylabel{S-FIELD5}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash \Const \; F_{1} \subtype_{u} \Const \; F_{2}}
\]

\mylabel{S-FIELD6}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash \Const \; F_{1} \subtype_{u} F_{2}}
\]

\mylabel{S-FIELD7}
\[
\dfrac{\senv \vdash F_{1} \subtype F_{2}}
      {\senv \vdash F_{1} \subtype_{u} \Const \; F_{2}}
\]

\mylabel{S-FIELD8}
\[
\dfrac{\senv \vdash \Nil \subtype F}
      {\senv \vdash \Nil \subtype_{o} F}
\]

\mylabel{S-FIELD9}
\[
\dfrac{\senv \vdash \Nil \subtype F}
      {\senv \vdash \Nil \subtype_{o} \Const \; F}
\]

\mylabel{S-AMBER}
\[
\dfrac{\senv[x_{1} \subtype x_{2}] \vdash F_{1} \subtype F_{2}}
      {\senv \vdash \mu x_{1}.F_{1} \subtype \mu x_{2}.F_{2}}
\]

\mylabel{S-ASSUMPTION}
\[
\dfrac{x_{1} \subtype x_{2} \in \senv}
      {\senv \vdash x_{1} \subtype x_{2}}
\]

\mylabel{S-UNFOLDR}
\[
\dfrac{\senv \vdash F_{1} \subtype [x \mapsto \mu x.F_{2}]F_{2}}
      {\senv \vdash F_{1} \subtype \mu x.F_{2}}
\]

\mylabel{S-UNFOLDL}
\[
\dfrac{\senv \vdash [x \mapsto \mu x.F_{1}]F_{1} \subtype F_{2}}
      {\senv \vdash \mu x.F_{1} \subtype F_{2}}
\]

\mylabel{S-EXPRESSION}
\[
\senv \vdash T \subtype T
\]

\mylabel{S-PAIR2}
\[
\dfrac{\senv \vdash T_{1} \subtype T_{2} \;\;\;
       \senv \vdash E_{1} \subtype E_{2}}
      {\senv \vdash T_{1} \times E_{1} \subtype T_{2} \times E_{2}}
\]

\mylabel{S-VARARG4}
\[
\dfrac{\senv \vdash T_{1} \cup \Nil \subtype T_{2} \cup \Nil}
      {\senv \vdash T_{1}{*} \subtype T_{2}{*}}
\]

\mylabel{S-VARARG5}
\[
\dfrac{\senv \vdash T_{1} \cup \Nil \subtype T_{2} \;\;\;
       \senv \vdash T_{1}{*} \subtype E_{2}}
      {\senv \vdash T_{1}{*} \subtype T_{2} \times E_{2}}
\]

\mylabel{S-VARARG6}
\[
\dfrac{\senv \vdash T_{1} \subtype T_{2} \cup \Nil \;\;\;
       \senv \vdash E_{1} \subtype T_{2}{*}}
      {\senv \vdash T_{1} \times E_{1} \subtype T_{2}{*}}
\]

\mylabel{C-ANY1}
\[
\senv \vdash F \lesssim \Any
\]

\mylabel{C-ANY2}
\[
\senv \vdash \Any \lesssim F
\]

\section{Typing rules}

\noindent

\mylabel{T-SKIP}
\[
\env_{1}, \penv \vdash \mathbf{skip}, \env_{1}
\]

\mylabel{T-SEQ}
\[
\dfrac{\env_{1}, \penv \vdash s_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash s_{2}, \env_{3}}
      {\env_{1}, \penv \vdash s_{1} \; ; \; s_{2}, \env_{3}}
\]

\mylabel{T-ASSIGNMENT}
\[
\dfrac{\env_{1}, \penv \vdash el:S_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash \overline{l}:S_{2}, \env_{3} \;\;\;
       S_{1} \lesssim S_{2}}
      {\env_{1}, \penv \vdash \overline{l} = el,\env_{3}}
\]

\mylabel{T-METHOD1}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = F_{s} \;\;\;
       F_{s} = \{\overline{F{:}V}\}_{unique} \\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \nexists i \in 1..n \; L \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}| \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, \self \mapsto F_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       F_{o} = \{\overline{F{:}V}, L{:}\Const \; \Self \times F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S\}_{unique}\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto F_{o}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F}){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = F_{s} \;\;\;
       F_{s} = \{\overline{F{:}V}\}_{open} \\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \nexists i \in 1..n \; L \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}| \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, \self \mapsto F_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       F_{o} = \{\overline{F{:}V}, L{:}\Const \; \Self \times F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S\}_{open}\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto F_{o}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F}){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD3}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = F_{s} \;\;\;
       F_{s} = \{\overline{F{:}V}\}_{unique} \\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \nexists i \in 1..n \; L \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}| \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, {...} \mapsto F, \self \mapsto F_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       F_{o} = \{\overline{F{:}V}, L{:}\Const \; \Self \times F_{1} \times ... \times F_{n} \times F{*} \rightarrow S\}_{unique}\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto F_{o}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F},{...}{:}F){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD4}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = F_{s} \;\;\;
       F_{s} = \{\overline{F{:}V}\}_{open} \\
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       \nexists i \in 1..n \; L \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}| \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, {...} \mapsto F, \self \mapsto F_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       F_{o} = \{\overline{F{:}V}, L{:}\Const \; \Self \times F_{1} \times ... \times F_{n} \times F{*} \rightarrow S\}_{open}\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto F_{o}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F},{...}{:}F){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD5}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = F_{s} \;\;\;
       F_{s} = \{\overline{F{:}V}\}_{unique} \;\;\;
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       n = |\overline{F{:}V}| \\
       \exists i \in 1..n \; L \subtype F_{i} \wedge F_{i} \subtype L \wedge
       \Const \; \Self \times F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S \subtype V_{i} \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, \self \mapsto F_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       V_{i} \mapsto \Const \; \Self \times F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto F_{s}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F}){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD6}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = F_{s} \;\;\;
       F_{s} = \{\overline{F{:}V}\}_{open} \;\;\;
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       n = |\overline{F{:}V}| \\
       \exists i \in 1..n \; L \subtype F_{i} \wedge F_{i} \subtype L \wedge
       \Const \; \Self \times F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S \subtype V_{i} \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, \self \mapsto F_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       V_{i} \mapsto \Const \; \Self \times F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto F_{s}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F}){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD7}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = F_{s} \;\;\;
       F_{s} = \{\overline{F{:}V}\}_{unique} \;\;\;
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       n = |\overline{F{:}V}| \\
       \exists i \in 1..n \; L \subtype F_{i} \wedge F_{i} \subtype L \wedge
       \Const \; \Self \times F_{1} \times ... \times F_{n} \times F{*} \rightarrow S \subtype V_{i} \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, {...} \mapsto F, \self \mapsto F_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       V_{i} \mapsto \Const \; \Self \times F_{1} \times ... \times F_{n} \times F{*} \rightarrow S\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto F_{s}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F},{...}{:}F){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-METHOD8}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id_{1}) = F_{s} \;\;\;
       F_{s} = \{\overline{F{:}V}\}_{open} \;\;\;
       \env_{1}, \penv \vdash id_{2} : L, \env_{2} \;\;\;
       n = |\overline{F{:}V}| \\
       \exists i \in 1..n \; L \subtype F_{i} \wedge F_{i} \subtype L \wedge
       \Const \; \Self \times F_{1} \times ... \times F_{n} \times F{*} \rightarrow S \subtype V_{i} \\
       closeall(\env_{1})[self \mapsto \Self, \overline{id \mapsto F}, {...} \mapsto F, \self \mapsto F_{s}],
       \penv[\ret \mapsto S] \vdash s, \env_{3}\\
       V_{i} \mapsto \Const \; \Self \times F_{1} \times ... \times F_{n} \times F{*} \rightarrow S\\
       \env_{4} = openset(\env_{1}[id_{1} \mapsto F_{s}], frv(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s)) \\
       \env_{5} = closeset(\env_{4}, fav(\mathbf{fun} \; (\overline{id{:}T}){:}S \; s))
       \end{array}}
      {\begin{array}{c}
       \env_{1}, \penv \vdash \mathbf{fun} \; id_{1}{:}id_{2} \; (\overline{id{:}F},{...}{:}F){:}S \; s, \env_{5}\\
       \end{array}}
\]

\mylabel{T-WHILE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:F, \env_{2} \;\;\;
       closeall(\env_{2}), \penv \vdash s, \env_{3}\\
       \env_{4} = closeset(\env_{2}, fav(s)) \\
       \env_{5} = openset(\env_{4},frv(s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{while} \; e \; \mathbf{do} \; s,\env_{5}}
\]

\mylabel{T-WHILE2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = F\\
       closeall(\env_{1}[id \mapsto \phi(F, filter(F, \Nil))]), \penv \vdash s, \env_{2}\\
       \env_{3} = openset(\env_{1}[id \mapsto F], frv(s))\\
       \env_{4} = closeset(\env_{3}, fav(s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{while} \; id \; \mathbf{do} \; s,\env_{4}}
\]

\mylabel{T-IF1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:T, \env_{2} \;\;\;
       \env_{2}, \penv \vdash s_{1}:\env_{3} \;\;\;
       \env_{2}, \penv \vdash s_{2}:\env_{4} \;\;\;
       \env_{5} = join(\env_{3}, \env_{4})
       \end{array}}
      {\env_{1} \vdash \mathbf{if} \; e \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{5}}
\]

\mylabel{T-IF2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = F \;\;\;
       F_{t} = fot(F, \Nil) \;\;\;
       F_{e} = fit(F, \Nil) \\
       \env_{1}[id \mapsto \phi(F,F_{t})], \penv \vdash s_{1}, \env_{2}\\
       \env_{1}[id \mapsto \phi(F,F_{e})], \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = join(\env_{2}, \env_{3})
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}[id \mapsto F]}
\]

\mylabel{T-IF3}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = F \;\;\;
       F_{t} = fot(F, \Nil) \;\;\;
       F_{e} = fit(F, \Nil) \\
       F_{e} = \Void \;\;\;
       \env_{1}[id \mapsto \phi(F,F_{t})], \penv \vdash s_{1}, \env_{2}
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{2}[id \mapsto F]}
\]

\mylabel{T-IF4}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = F \;\;\;
       F_{t} = fot(F, \Nil) \;\;\;
       F_{e} = fit(F, \Nil) \\
       F_{t} = \Void \;\;\;
       \env_{1}[id \mapsto \phi(F,F_{e})], \penv \vdash s_{2}, \env_{2}
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{2}[id \mapsto F]}
\]

\mylabel{T-IF5}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \\
       S_{t} = fopt(\penv(x), \Nil, i) \;\;\;
       S_{e} = fipt(\penv(x), \Nil, i) \\
       \env_{1}, \penv[x \mapsto S_{t}] \vdash s_{1}, \env_{2}\\
       \env_{1}, \penv[x \mapsto S_{e}] \vdash s_{2}, \env_{3}\\
       \env_{4} = join(\env_{2}, \env_{3})
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}}
\]

\mylabel{T-IF6}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \\
       S_{t} = fopt(\penv(x), \Nil, i) \\
       fit(proj(\penv(x), i), \Nil) = \Void \\
       \env_{1}, \penv[x \mapsto S_{t}] \vdash s_{1}, \env_{2}
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{2}}
\]

\mylabel{T-IF7}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \pi_{i}^{x} \\
       S_{e} = fipt(\penv(x), \Nil, i) \\
       fot(proj(\penv(x), i), \Nil) = \Void \\
       \env_{1}, \penv[x \mapsto S_{e}] \vdash s_{2}, \env_{2}
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; id \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{2}}
\]

\mylabel{T-IF8}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \phi(F_{1},F_{2}) \;\;\;
       F_{t} = fit(F_{2}, \String) \;\;\;
       F_{e} = fot(F_{2}, \String) \\
       \env_{1}[id \mapsto \phi(F_{1},F_{t})], \penv \vdash s_{1}, \env_{2}\\
       \env_{1}[id \mapsto \phi(F_{1},F_{e})], \penv \vdash s_{2}, \env_{3}\\
       \env_{4} = join(\env_{2}, \env_{3})
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``string" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{4}[id \mapsto F_{1}]}
\]

\mylabel{T-IF9}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \phi(F_{1},F_{2}) \;\;\;
       F_{t} = fit(F_{2}, \String) \;\;\;
       F_{e} = fot(F_{2}, \String) \\
       F_{t} = \Void \;\;\;
       \env_{1}[id \mapsto \phi(F_{1},F_{e})], \penv \vdash s_{2}, \env_{2}
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``string" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{2}[id \mapsto F_{1}]}
\]

\mylabel{T-IF10}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \phi(F_{1},F_{2}) \;\;\;
       F_{t} = fit(F_{2}, \String) \;\;\;
       F_{e} = fot(F_{2}, \String) \\
       F_{e} = \Void \;\;\;
       \env_{1}[id \mapsto \phi(F_{1},F_{t})], \penv \vdash s_{1}, \env_{2}
      \end{array}}
      {\env_{1}, \penv \vdash \mathbf{if} \; type(id) == ``string" \; \mathbf{then} \; s_{1} \; \mathbf{else} \; s_{2}, \env_{2}[id \mapsto F_{1}]}
\]

\mylabel{T-LOCAL1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash el:S, \env_{2} \\
       S \lesssim F_{1} \times ... \times F_{n} \times \Value{*} \;\;\;
       n = |\;\overline{id{:}F}\;| \\
       \env_{2}[\overline{id \mapsto F}], \penv \vdash s, \env_{3}
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{local} \; \overline{id{:}F} = el \; \mathbf{in} \; s, (\env_{3} - \{\overline{id}\})[\overline{id \mapsto \env_{2}(id)]}}
\]

\mylabel{T-LOCAL2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash el:E, \env_{2}, (x,S) \\
       \env_{3} = \env_{2}[id_{1} \mapsto infer(E,1), ..., id_{n} \mapsto infer(E,n)] \\
       \env_{3}, \penv[x \mapsto S] \vdash s, \env_{4} \;\;\;
       n = |\;\overline{id}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{local} \; \overline{id} = el \; \mathbf{in} \; s, (\env_{4} - \{\overline{id}\})[\overline{id \mapsto \env_{2}(id)]}}
\]

\mylabel{T-LOCALREC}
\[
\dfrac{\env_{1}[id \mapsto F], \penv \vdash e:F_{1}, \env_{2} \;\;\;
       F_{1} \lesssim F \;\;\;
       \env_{2}, \penv \vdash s, \env_{3}}
      {\env_{1}, \penv \vdash \mathbf{rec} \; id{:}F = e \; \mathbf{in} \; s, (\env_{3} - \{id\})[\overline{id \mapsto \env_{2}(id)]}}
\]

\mylabel{T-RETURN}
\[
\dfrac{\env_{1} \vdash el:S_{1}, \env_{2} \;\;\;
       \penv(\ret) = S_{2} \;\;\;
       S_{1} \lesssim S_{2}}
      {\env_{1} \vdash \mathbf{return} \; el, \env_{2}}
\]

\mylabel{T-STMAPPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e(el) \rfloor_{0},\env_{2}}
\]

\mylabel{T-STMINVOKE1}
\[
\dfrac{\env_{1}, \penv \vdash e{:}n(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e{:}n(el) \rfloor_{0}, \env_{2}}
\]

\mylabel{T-NIL}
\[
\env_{1}, \penv \vdash \mathbf{nil}:\Nil, \env_{1}
\]

\mylabel{T-FALSE}
\[
\env_{1}, \penv \vdash \mathbf{false}:\False, \env_{1}
\]

\mylabel{T-TRUE}
\[
\env_{1}, \penv \vdash \mathbf{true}:\True, \env_{1}
\]

\mylabel{T-INT}
\[
\env_{1}, \penv \vdash {\it int}:{\it int}, \env_{1}
\]

\mylabel{T-FLOAT}
\[
\env_{1}, \penv \vdash {\it float}:{\it float}, \env_{1}
\]

\mylabel{T-STR}
\[
\env_{1}, \penv \vdash {\it string}:{\it string}, \env_{1}
\]

\mylabel{T-IDREAD1}
\[
\dfrac{\env_{1}(id) = F}
      {\env_{1}, \penv \vdash id:close(F), \env_{1}[id \mapsto open(F)]}
\]

\mylabel{T-IDREAD2}
\[
\dfrac{\env_{1}(id) = F}
      {\env_{1}, \penv \vdash id:fix(F), \env_{1}[id \mapsto fix(F)]}
\]

\mylabel{T-IDREAD3}
\[
\dfrac{\env_{1}(id) = \phi(F_{1},F_{2})}
      {\env_{1}, \penv \vdash id:F_{2}, \env_{1}}
\]

\mylabel{T-IDREAD4}
\[
\dfrac{\env_{1}(id) = \pi_{i}^{x}}
      {\env_{1}, \penv \vdash id:proj(\penv(x), i), \env_{1}}
\]

\mylabel{T-INDEXREAD1}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \{\overline{F{:}V}\} \;\;\;
       \env_{1}, \penv \vdash e_{2}:F, \env_{2} \;\;\;
       \exists i \in 1{..}n \; F \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash id[e_{2}]:rconst(V_{i}), \env_{2}}
\]

\mylabel{T-INDEXREAD2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{1}:\{\overline{F{:}V}\}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3} \;\;\;
       \exists i \in 1{..}n \; F \lesssim F_{i} \;\;\;
       n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash e_{1}[e_{2}]:rconst(V_{i}), \env_{3}}
\]

\mylabel{T-INDEXREAD3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1}[e_{2}]:\Any, \env_{3}}
\]

\mylabel{T-COERCE1}
\[
\dfrac{\env_{1}(id) \subtype F \;\;\; tag(F,closed)}
      {\env_{1}, \penv \vdash {<}F{>} \; id:F, \env_{1}[id \mapsto reopen(F)]}
\]

\mylabel{T-COERCE2}
\[
\dfrac{\env_{1}(id) \subtype F \;\;\; tag(F,fixed)}
      {\env_{1}, \penv \vdash {<}F{>} \; id:F, \env_{1}[id \mapsto F]}
\]

\mylabel{T-FUNCTION1}
\[
\dfrac{\begin{array}{c}
       closeall(\env_{1})[\overline{id \mapsto F}], \penv[\ret \mapsto S] \vdash s, \env_{2} \\
       \env_{3} = openset(\env_{1}, frv(\mathbf{fun} \; (\overline{id{:}F}){:}S \; s)) \\
       \env_{4} = closeset(\env_{3}, fav(\mathbf{fun} \; (\overline{id{:}F}){:}S \; s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{fun} \; (\overline{id{:}F}){:}S \; s:F_{1} \times ... \times F_{n} \times \Nil{*} \rightarrow S, \env_{4}}
\]

\mylabel{T-FUNCTION2}
\[
\dfrac{\begin{array}{c}
       closeall(\env_{1})[\overline{id \mapsto F}, {...} \mapsto F], \penv[\ret \mapsto S] \vdash s, \env_{2} \\
       \env_{3} = openset(\env_{1}, frv(\mathbf{fun} \; (\overline{id{:}F}){:}S \; s)) \\
       \env_{4} = closeset(\env_{3}, fav(\mathbf{fun} \; (\overline{id{:}F}){:}S \; s))
       \end{array}}
      {\env_{1}, \penv \vdash \mathbf{fun} \; (\overline{id{:}F},{...}{:}F){:}S \; s:F_{1} \times ... \times F_{n} \times F{*} \rightarrow S, \env_{4}}
\]

\mylabel{T-CONSTRUCTOR1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash ([e_{1}] = e_{2})_{i}:(F_{i},V_{i}), \env_{i+1} \;\;\;
       T = \{F_{1}{:}V_{1}, ..., F_{n}{:}V_{n}\}_{unique} \\
       wf(T) \;\;\;
       n = |\;\overline{[e_{1}] = e_{2}}\;| \;\;\;
       \env_{f} = merge(\env_{1}, ..., \env_{n+1})
       \end{array}}
      {\env_{1}, \penv \vdash \{\;\overline{[e_{1}] = e_{2}}\;\}:T, \env_{f}}
\]

\mylabel{T-CONSTRUCTOR2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash ([e_{1}] = e_{2})_{i}:(F_{i},V_{i}), \env_{i+1} \\
       \env_{1}, \penv \vdash me : F_{n+1} \times ... \times F_{n+m} \times F_{n+m+1}{*}, \env_{n+2}\\
       T = \{F_{1}{:}V_{1}, ..., F_{n}{:}V_{n}, 1{:}F_{n+1}, ..., m{:}F_{n+m}, \Integer{:}F_{n+m+1} \cup \Nil\}_{unique}\\
       wf(T) \;\;\;
       n = |\;\overline{[e_{1}] = e_{2}}\;| \;\;\;
       \env_{f} = merge(\env_{1}, ..., \env_{n+2})
       \end{array}}
      {\env_{1}, \penv \vdash \{\;\overline{[e_{1}] = e_{2}}\;\}:T, \env_{f}}
\]

\mylabel{T-FIELD}\\
\[
\dfrac{\env_{1}, \penv \vdash e_{2}:V, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{1}:F, \env_{3}}
      {\env_{1}, \penv \vdash [e_{1}] = e_{2}: (F,vt(F,V)), \env_{3}}
\]

\mylabel{T-ARITH1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       F_{1} \subtype \Integer \;\;\;
       F_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Integer, \env_{3}}
\]

\mylabel{T-ARITH2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       F_{1} \subtype \Integer \;\;\;
       F_{2} \subtype \Number}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       F_{1} \subtype \Number \;\;\;
       F_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       F_{1} \subtype \Number \;\;\;
       F_{2} \subtype \Number}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Number, \env_{3}}
\]

\mylabel{T-ARITH5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Any, \env_{3}}
\]

\mylabel{T-ARITH6}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} + e_{2}:\Any, \env_{3}}
\]

\mylabel{T-CONCAT1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       F_{1} \subtype \String \;\;\;
       F_{2} \subtype \String}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\String, \env_{3}}
\]

\mylabel{T-CONCAT2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-CONCAT3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; {..} \; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-EQUAL}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} == e_{2}:\Boolean, \env_{3}}
\]

\mylabel{T-ORDER1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       F_{1} \subtype \Number \;\;\;
       F_{2} \subtype \Number}
      {\env, \penv \vdash e_{1} < e_{2}:\Boolean, \env_{3}}
\]

\mylabel{T-ORDER2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       F_{1} \subtype \String \;\;\;
       F_{2} \subtype \String}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Boolean}
\]

\mylabel{T-ORDER3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Any, \env_{3}}
\]

\mylabel{T-ORDER4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} < e_{2}:\Any, \env_{3}}
\]

\mylabel{T-BITWISE1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       F_{1} \subtype \Integer \;\;\;
       F_{2} \subtype \Integer}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Integer, \env_{3}}
\]

\mylabel{T-BITWISE2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-BITWISE3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:\Any, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \;\&\; e_{2}:\Any, \env_{3}}
\]

\mylabel{T-AND1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\Nil, \env_{2}}
\]

\mylabel{T-AND2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\False, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\False, \env_{2}}
\]

\mylabel{T-AND3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil \cup \False, \env_{2}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:\Nil \cup \False, \env_{2}}
\]

\mylabel{T-AND4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       \Nil \not\lesssim F_{1} \;\;\;
       \False \not\lesssim F_{1}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:F_{2}, \env_{3}}
\]

\mylabel{T-AND5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2}:F_{1} \cup F_{2}, \env_{3}}
\]

\mylabel{T-OR1}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F, \env_{2} \;\;\;
       \Nil \not\lesssim F \;\;\;
       \False \not\lesssim F}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:F, \env_{2}}
\]

\mylabel{T-OR2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:F, \env_{3}}
\]

\mylabel{T-OR3}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\False, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:F, \env_{3}}
\]

\mylabel{T-OR4}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Nil \cup \False, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:F, \env_{3}}
\]

\mylabel{T-OR5}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{or} \; e_{2}:filter(filter(F_{1}, \Nil), \False) \cup F_{2}, \env_{3}}
\]

\mylabel{T-NOT1}
\[
\dfrac{\env_{1}, \penv \vdash e:\Nil, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT2}
\[
\dfrac{\env_{1}, \penv \vdash e:\False, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT3}
\[
\dfrac{\env_{1}, \penv \vdash e:\Nil \cup \False, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\True, \env_{2}}
\]

\mylabel{T-NOT4}
\[
\dfrac{\env_{1}, \penv \vdash e:F \;\;\;
       \Nil \not\lesssim F \;\;\;
       \False \not\lesssim F}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\False, \env_{2}}
\]

\mylabel{T-NOT5}
\[
\dfrac{\env_{1}, \penv \vdash e:F, \env_{2}}
      {\env_{1}, \penv \vdash \mathbf{not} \; e:\Boolean, \env_{2}}
\]

\mylabel{T-LEN1}
\[
\dfrac{\env_{1}, \penv \vdash e:F, \env_{2} \;\;\;
       F \subtype \String}
      {\env_{1}, \penv \vdash \# \; e:\Integer, \env_{2}}
\]

\mylabel{T-LEN2}
\[
\dfrac{\env_{1}, \penv \vdash e:F, \env_{2} \;\;\;
       F \subtype \{\}_{closed}}
      {\env_{1}, \penv \vdash \# \; e:\Integer, \env_{2}}
\]

\mylabel{T-LEN3}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2}}
      {\env_{1}, \penv \vdash \# \; e:\Any, \env_{2}}
\]

\mylabel{T-EXPAPPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e(el) \rfloor_{1}:proj(S,1), \env_{2}}
\]

\mylabel{T-EXPINVOKE1}
\[
\dfrac{\env_{1}, \penv \vdash e{:}n(el):S, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor e{:}n(el) \rfloor_{1}:proj(S,1), \env_{2}}
\]

\mylabel{T-EXPDOTS}
\[
\dfrac{\env_{1}, \penv \vdash {...}:F{*}, \env_{2}}
      {\env_{1}, \penv \vdash \lfloor {...} \rfloor_{1}:F \cup \Nil, \env_{2}}
\]

\mylabel{T-IDWRITE1}
\[
\dfrac{\env_{1}(id) = F}
      {\env_{1}, \penv \vdash id_{l}:F, \env_{1}}
\]

\mylabel{T-IDWRITE2}
\[
\dfrac{\env_{1}(id) = \phi(F_{1},F_{2})}
      {\env_{1}, \penv \vdash id_{l}:F_{1}, \env_{1}[id \mapsto F_{1}]}
\]

\mylabel{T-INDEXWRITE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{1}:\{\overline{F{:}V}\}, \env_{2} \\
       \env_{2}, \penv \vdash e_{2}:F, \env_{3} \;\;\;
       \exists i \in 1{..}n \; F \lesssim F_{i} \wedge \neg const(V_{i}) \;\;\;
       n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash e_{1}[e_{2}]_{l}:V_{i}, \env_{3}}
\]

\mylabel{T-INDEXWRITE2}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F, \env_{3}}
      {\env_{1}, \penv \vdash e_{1}[e_{2}]_{l}:\Any, \env_{3}}
\]

\mylabel{T-REFINE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \{\overline{F{:}V}\}_{unique}\\
       \env_{1}, \penv \vdash e:F_{new}, \env_{2} \;\;\;
       \nexists i \in 1..n \; F_{new} \lesssim F_{i} \;\;\;
       V_{new} = vt(F_{new},V) \;\;\; n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash id[e] {<}V{>}:V_{new}, \env_{2}[id \mapsto \{\overline{F{:}V}, F_{new}{:}V_{new}\}_{unique}]}
\]

\mylabel{T-REFINE2}
\[
\dfrac{\begin{array}{c}
       \env_{1}(id) = \{\overline{F{:}V}\}_{open}\\
       \env_{1}, \penv \vdash e:F_{new}, \env_{2} \;\;\;
       \nexists i \in 1..n \; F_{new} \lesssim F_{i} \;\;\;
       V_{new} = vt(F_{new},V) \;\;\; n = |\overline{F{:}V}|
       \end{array}}
      {\env_{1}, \penv \vdash id[e] {<}V{>}:V_{new}, \env_{2}[id \mapsto \{\overline{F{:}V}, F_{new}{:}V_{new}\}_{open}]}
\]

\mylabel{T-LHSLIST}
\[
\dfrac{\env_{1}, \penv \vdash l_{i}:F_{i}, \env_{i+1} \;\;\;
       \env_{f} = merge(\env_{1}, ..., \env_{n+1}) \;\;\;
       n = |\;\overline{l}\;|}
      {\env_{1}, \penv \vdash \overline{l}:F_{1} \times ... \times F_{n} \times \Value{*}, \env_{f}}
\]

\mylabel{T-EXPLIST1}
\[
\dfrac{\env_{1}, \penv \vdash e_{i}:F_{i}, \env_{i+1} \;\;\;
       \env_{f} = merge(\env_{1}, ..., \env_{n+1}) \;\;\;
       n = |\;\overline{e}\;|}
      {\env_{1}, \penv \vdash \overline{e}:F_{1} \times ... \times F_{n} \times \Nil{*}, \env_{f}}
\]

\mylabel{T-EXPLIST2}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{i}:F_{i}, \env_{i+1} \;\;\;
       \env_{1}, \penv \vdash me:F_{n+1} \times ... \times F_{n+m} \times F_{n+m+1}{*}, \env_{n+2}\\
       \env_{f} = merge(\env_{1}, ..., \env_{n+2}) \;\;\;
       n = |\;\overline{e}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \overline{e},me:F_{1} \times ... \times F_{n+m} \times F_{n+m+1}{*}, \env_{f}}
\]

\mylabel{T-EXPLIST3}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e_{i}:F_{i}, \env_{i+1} \;\;\;
       \env_{1}, \penv \vdash me:S, \env_{n+2}\\
       S = F_{n+1} \times ... \times F_{n+m} \times \Nil{*} \sqcup F_{n+1}' \times ... \times F_{n+m}' \times \Nil{*} \\
       \env_{f} = merge(\env_{1}, ..., \env_{n+2}) \;\;\;
       n = |\;\overline{e}\;|
       \end{array}}
      {\env_{1}, \penv \vdash \overline{e},me:F_{1} \times ... \times F_{n} \times \pi_{1}^{x} \times ... \times \pi_{m}^{x} \times \Nil{*}, \env_{f}, (x,S)}
\]

\mylabel{T-APPLY1}
\[
\dfrac{\env_{1}, \penv \vdash e:S_{1} \rightarrow S_{2}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S_{3}, \env_{3} \;\;\;
       S_{3} \lesssim S_{1}}
      {\env_{1}, \penv \vdash e(el):S_{2}, \env_{3}}
\]

\mylabel{T-APPLY2}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S, \env_{3}}
      {\env_{1}, \penv \vdash e_{1}(el):\Any{*}, \env_{3}}
\]

\mylabel{T-INVOKE1}
\[
\dfrac{\begin{array}{c}
       \env_{1}, \penv \vdash e:F, \env_{2}\\
       \env_{2}[\sigma \mapsto F], \penv \vdash e[id]:\Const \; S_{1} \rightarrow S_{2}, \env_{3}\\
       \env_{3}[\sigma \mapsto F], \penv \vdash el:S_{3}, \env_{4} \;\;\;
       F \times S_{3} \lesssim [\Self \mapsto F]S_{1}
       \end{array}}
      {\env_{1}, \penv \vdash e{:}id(el):[\Self \mapsto F]S_{2}, \env_{4}}
\]

\mylabel{T-INVOKE2}
\[
\dfrac{\env_{1}, \penv \vdash e:\Any, \env_{2} \;\;\;
       \env_{2}, \penv \vdash el:S, \env_{3}}
      {\env_{1}, \penv \vdash e{:}id(el):\Any{*}, \env_{3}}
\]

\mylabel{T-DOTS}
\[
\dfrac{\env_{1}({...}) = F}
      {\env_{1}, \penv \vdash {...}:F{*}, \env_{1}}
\]

\mylabel{T-SELF}
\[
\dfrac{\env_{1}, \penv \vdash e:\Self, \env_{2} \;\;\;
       \env_{2}(\self) = F}
      {\env_{1}, \penv \vdash e:F, \env_{2}}
\]

\mylabel{T-SETMETATABLE1}
\[
\dfrac{\env_{1}(id) = \Self}
      {\env_{1}, \penv \vdash setmetatable(\{\}, \{[``\string_\string_index"] = id\}):\Self, \env_{1}}
\]

\mylabel{T-SETMETATABLE2}
\[
\dfrac{\env_{1}(id) = \{F_{1}{:}V_{1}, ..., F_{n}{:}V_{n}\}_{fixed}}
      {\env_{1}, \penv \vdash setmetatable(\{\}, \{[``\string_\string_index"] = id\}):\{F_{1}{:}V_{1}, ..., F_{n}{:}V_{n}\}_{open}, \env_{1}}
\]

\mylabel{T-SETMETATABLE3}
\[
\dfrac{\env_{1}, \penv \vdash e : T, \env_{2} \;\;\;
       T = \{F_{1}{:}V_{1}, ..., F_{n}{:}V_{n}\}_{closed} \;\;\;
       \env_{1}(id) = \Self \;\;\; \env_{1}(\sigma) \subtype T}
      {\env_{1}, \penv \vdash setmetatable(e, \{[``\string_\string_index"] = id\}):\Self, \env_{2}[\sigma \mapsto T]}
\]

\mylabel{T-UNFOLD}
\[
\dfrac{\env_{1}, \penv \vdash e:\mu x.F, \env_{2}}
      {\env_{1}, \penv \vdash e:[x \mapsto \mu x.F]F, \env_{2}}
\]

\mylabel{T-FOLD}
\[
\dfrac{\env_{1}, \penv \vdash e:[x \mapsto \mu x.F]F, \env_{2}}
      {\env_{1}, \penv \vdash e:\mu x.F, \env_{2}}
\]

\mylabel{T-TERNARY}
\[
\dfrac{\env_{1}, \penv \vdash e_{1}:F_{1}, \env_{2} \;\;\;
       \env_{2}, \penv \vdash e_{2}:F_{2}, \env_{3} \;\;\;
       \env_{3}, \penv \vdash e_{3}:F_{2}, \env_{4}}
      {\env_{1}, \penv \vdash e_{1} \; \mathbf{and} \; e_{2} \; \mathbf{or} \; e_{3}:F_{2}, \env_{4}}
\]

\section{Auxiliary functions}

\noindent

\begin{align*}
wf(\{\overline{F:V}\}_{unique|open|fixed|closed}) & = \forall i \; ((\nexists j \; i \not= j \,\wedge\, F_{i} \lesssim F_{j}) \,\wedge\, wf(V_{i}) \,\wedge\\
& \;\;\;\; \lnot tag(V_{i},unique) \,\wedge\, \lnot tag(V_{i},open))\\
wf({\bf const}\; F) & = wf(F) \\
wf(F_1 \cup F_2) & = wf(F_1) \,\wedge\, wf(F_2) \\
wf(\mu x.F) & = wf(F) \\
wf(S_1 \rightarrow S_2) & = wf(S_1) \,\wedge\, wf(S_2) \\
wf(S_1 \sqcup S_2) & = wf(S_1) \,\wedge\, wf(S_2)\\
wf(F{*}) & = wf(F) \\
wf(F \times P) & = wf(F) \,\wedge\,wf(P)\\
wf(F) & = \top \;\;\;\mathrm{for\; all\; other\; cases}
\end{align*}

\begin{align*}
tag(F_1 \cup F_2, t) & = tag(F_1, t) \,\vee\, tag(F_2,t) \\
tag(\{\overline{F{:}V}\}_{t}, t) & = \top\\
tag(\{\overline{F{:}V}\}_{t_{1}}, t_{2}) & = \bot\\
tag(F, t) & = \bot
\end{align*}

\begin{align*}
vt(L, V) & = fix(V) \\
vt(F_1, F_2) & = nil(fix(F_2))\\
vt(F_1, {\bf const}\;F_2) & = {\bf const}\;nil(fix(F_2))
\end{align*}

\begin{align*}
nil(T) & = \left\{
\begin{array}{ll}
T & \text{if $\Nil \lesssim T$} \\
T \cup \Nil & \text{otherwise}
\end{array} \right.
\end{align*}

\begin{align*}
fix(F_{1} \cup F_{2}) & = fix(F_{1}) \cup fix(F_{2})\\
fix(\{\overline{F{:}V}\}_{unique|open}) & = \{\overline{F{:}V}\}_{fixed} \\
fix(F) & = F
\end{align*}

\begin{align*}
close(F_{1} \cup F_{2}) & = close(F_{1}) \cup close(F_{2})\\
close(\{\overline{F{:}V}\}_{unique|open}) & = \{\overline{F{:}V}\}_{closed} \\
close(F) & = F
\end{align*}

\begin{align*}
open(F_{1} \cup F_{2}) & = open(F_{1}) \cup open(F_{2})\\
open(\{\overline{F{:}V}\}_{unique}) & = \{\overline{F{:}V}\}_{open} \\
open(F) & = F
\end{align*}

\begin{align*}
reopen(\{\overline{F:V}\}_{closed}) & = \{\overline{F:V}\}_{open}\\
reopen(F) & = F
\end{align*}

\begin{align*}
rconst({\bf const}\;F) & = F\\
rconst(F) & = F
\end{align*}

\begin{align*}
const({\bf const}\;F) & = \top\\
const(F) & = \bot
\end{align*}

\begin{align*}
proj(S_1 \sqcup S_2, i) & = proj(S_1, i) \cup proj(S_2, i) \\
proj(F{*}, i) & = nil(F) \\
proj(F \times P, 1) & = F \\
proj(F \times P, i) & = proj(P, i-1)\\
proj(E{*}, i) & = nil(E) \\
proj(T \times E, 1) & = T \\
proj(T \times E, i) & = proj(E, i-1)
\end{align*}

\begin{align*}
infer(T_{1} \times ... \times T_{n}{*}, i) & = \left\{
\begin{array}{ll}
general(T_{i}) & \text{if $i < n$}\\
general(nil(T_{n})) & \text{if $i >= n$}
\end{array} \right.
\end{align*}

\begin{align*}
general(\False) & = \Boolean\\
general(\True) & = \Boolean\\
general({\it int}) & = \Integer\\
general({\it float}) & = \Number\\
general({\it string}) & = \String\\
general(F_{1} \cup F_{2}) & = general(F_{1}) \cup general(F_{2})\\
general(S_{1} \rightarrow S_{2}) & = general2(S_{1}) \rightarrow general2(S_{2})\\
general(\{F_{1}{:}V_{1}, ..., F_{n}{:}V_{n}\}_{tag}) & = \{F_{1}{:}general(V_{1}), ..., F_{n}{:}general(V_{n})\}_{tag}\\
general(\mu x.F) & = \mu x.general(F)\\
general(T) & = T
\end{align*}

\begin{align*}
general2(F{*}) & = general(F){*}\\
general2(F \times P) & = general(F) \times general2(P)\\
general2(S_{1} \sqcup S_{2}) & = general2(S_{1}) \sqcup general2(S_{2})
\end{align*}

\begin{align*}
closeall(\env[id_{1} \mapsto T_{1}, ..., id_{n} \mapsto T_{n}]) & = \env[id_{1} \mapsto close(T_{1}), ..., id_{n} \mapsto close(T_{n})]
\end{align*}

\begin{align*}
closeset(\env, \{id_{1}, ..., id_{n}\}) & = \env[id_{1} \mapsto close(\env(id_{1})), ..., id_{n} \mapsto close(\env(id_{n}))]
\end{align*}

\begin{align*}
openset(\env, \{id_{1}, ..., id_{n}\}) & = \env[id_{1} \mapsto open(\env(id_{1})), ..., id_{n} \mapsto open(\env(id_{n}))]
\end{align*}

\begin{align*}
merge(\overline{\env}) & = reduce(\overline{\env}, merge2)\\
merge2(\env_1,\env_2) & = \{\overline{(id,merget(\env_1(id),\env_2(id))}\}\\
merget(T_1, T_2) & = T_1 \;\;\; \mathrm{if\;} T_2 \lesssim T_1\\
merget(T_1, T_2) & = T_2 \;\;\; \mathrm{if\;} T_1 \lesssim T_2\\
& \;\;\;\;\; \mathrm{the\;next\;case\;applies\;if} \\
& \;\;\;\;\; \overline{V^l \lesssim_u V_r \,\vee\, V^r \lesssim_u V_l}\\
& \;\;\;\;\; \mathrm{and\;the\;right\; side\; is\;}wf\\
merget(\{\overline{F:V^l},\overline{F^{\prime}:V^\prime}\}_{unique},\\
\{\overline{F:V^r},\overline{F^{\prime\prime}:V^{\prime\prime}}\}_{unique}) & =
\{\overline{F:sup_u(V^l,V^r)},\\
& \;\;\;\;\;\; \overline{F^\prime:V^\prime},\\
& \;\;\;\;\;\; \overline{F^{\prime\prime}:V^{\prime\prime}}\}_{unique}\\
& \;\;\;\;\; \mathrm{the\;next\;case\;applies\;if} \\
& \;\;\;\;\; \overline{V^l \lesssim_c V_r \,\vee\, V^r \lesssim_c V_l}\\
& \;\;\;\;\; \mathrm{and\;the\;right\; side\; is\;}wf\\
merget(\{\overline{F:V^l},\overline{F^{\prime}:V^{\prime}}\}_{unique|open},\\
\{\overline{F:V^r},\overline{F^{\prime\prime}:V^{\prime\prime}}\}_{unique|open}) & =
\{\overline{F:sup_c(V^l,V^r)},\\
& \;\;\;\;\;\; \overline{F^\prime:V^\prime},\\
& \;\;\;\;\;\; \overline{F^{\prime\prime}:V^{\prime\prime}}\}_{open}\\
merget(T_1, T_2) & = \bot \;\;\; \mathrm{otherwise}
\end{align*}

\begin{align*}
sup_u(V_1, V_2) & = V_2 \;\;\; \mathrm{if}\; V_1 \lesssim_u V_2\\
sup_u(V_1, V_2) & = V_1 \;\;\; \mathrm{if}\; V_2 \lesssim_u V_1
\end{align*}

\begin{align*}
sup_c(V_1, V_2) & = V_2 \;\;\; \mathrm{if}\; V_1 \lesssim_c V_2\\
sup_c(V_1, V_2) & = V_1 \;\;\; \mathrm{if}\; V_2 \lesssim_c V_1
\end{align*}

\begin{align*}
join(\env_1,\env_2) & = \{\overline{(id,joint(\env_1(id),\env_2(id))}\}\\
joint(T_1, T_2) & = T_1 \;\;\; \mathrm{if\;} T_2 \lesssim T_1\\
joint(T_1, T_2) & = T_2 \;\;\; \mathrm{if\;} T_1 \lesssim T_2\\
& \;\;\;\;\; \mathrm{the\;next\;case\;applies\;if}\; \\
& \;\;\;\;\; \overline{V^l \lesssim_u V_r \,\vee\, V^r \lesssim_u V_l}\\
& \;\;\;\;\; \mathrm{and\;the\;right\; side\; is\;}wf\\
joint(\{\overline{F:V^l},\overline{F^{\prime}:V^{\prime}}\}_{unique},
\{\overline{F:V^r},\overline{F^{\prime\prime}:V^{\prime\prime}}\}_{unique}) & =
\{\overline{F:sup_u(V^l,V^r)},\\
& \;\;\;\;\;\; \overline{F^\prime:nil(V^\prime)},\\
& \;\;\;\;\;\; \overline{F^{\prime\prime}:nil(V^{\prime\prime})}\}_{unique}\\
joint(T_1, T_2) & = \bot \;\;\; \mathrm{otherwise}
\end{align*}

\begin{align*}
filter(F_{1} \cup F_{2}, F_{1}) & = filter(F_{2}, F_{1})\\
filter(F_{1} \cup F_{2}, F_{2}) & = filter(F_{1}, F_{2})\\
filter(F_{1} \cup F_{2}, F_{3}) & = filter(F_{1}, F_{3}) \cup filter(F_{2}, F_{3})\\
filter(F_{1}, F_{2}) & = F_{1}
\end{align*}

\begin{align*}
fopt(P_1 \sqcup P_2, F, i) & = P_2 & \mathrm{if} \; fot(proj(P_1, i),F) = {\bf void} \\
fopt(P_1 \sqcup P_2, F, i) & = P_1 & \mathrm{if} \; fot(proj(P_2, i),F) = {\bf void} \\
fopt(P_1 \sqcup P_2, F, i) & = P_1 \sqcup P_2 & \mathrm{otherwise}\\
fopt(P \sqcup S, F, i) & = fopt(S,F,i) & \mathrm{if} \; fot(proj(P, i),F) = {\bf void} \\
fopt(P \sqcup S, F, i) & = P \sqcup fopt(S,F,i) & \mathrm{otherwise}\\
fopt(S \sqcup P_2, F, i) & = fopt(S,F,i) & \mathrm{if} \; fot(proj(P, i),F) = {\bf void} \\
fopt(S \sqcup P, F, i) & = fopt(S,F,i) \sqcup P & \mathrm{otherwise}\\
fopt(S_1 \sqcup S_2, F, i) & = fopt(S_1,F,i) \sqcup fopt(S_2,F,i)
\end{align*}

\begin{align*}
fot(F_1 \cup F_2,F_3) & = fot(F_1,F_3) & \mathrm{if}\;fot(F_2,F_3) = {\bf void}\\
fot(F_1 \cup F_2,F_3) & = fot(F_2,F_3) & \mathrm{if}\;fot(F_1,F_3) = {\bf void}\\
fot(F_1 \cup F_2,F_3) & = fot(F_1,F_3) \cup fot(F_2,F_3) & \mathrm{otherwise}\\
fot(F_1,F_2) & = {\bf void} & \mathrm{if} \; F_1 \subtype F_2 \; \mathrm{and} \; F_2 \subtype F_1\\
fot(F_1,F_2) & = F_1 & \mathrm{otherwise}
\end{align*}

\begin{align*}
fipt(P_1 \sqcup P_2, F, i) & = P_2 & \mathrm{if} \; fit(proj(P_1, i),F) = {\bf void} \\
fipt(P_1 \sqcup P_2, F, i) & = P_1 & \mathrm{if} \; fit(proj(P_2, i),F) = {\bf void} \\
fipt(P_1 \sqcup P_2, F, i) & = P_1 \sqcup P_2 & \mathrm{otherwise}\\
fipt(P \sqcup S, F, i) & = fipt(S,F,i) & \mathrm{if} \; fit(proj(P, i),F) = {\bf void} \\
fipt(P \sqcup S, F, i) & = P \sqcup fipt(S,F,i) & \mathrm{otherwise}\\
fipt(S \sqcup P_2, F, i) & = fipt(S,F,i) & \mathrm{if} \; fit(proj(P, i),F) = {\bf void} \\
fipt(S \sqcup P, F, i) & = fipt(S,F,i) \sqcup P & \mathrm{otherwise}\\
fipt(S_1 \sqcup S_2, F, i) & = fipt(S_1,F,i) \sqcup fipt(S_2,F,i)
\end{align*}

\begin{align*}
fit(F_1 \cup F_2,F_3) & = fit(F_1,F_3) & \mathrm{if}\;fit(F_2,F_3) = {\bf void}\\
fit(F_1 \cup F_2,F_3) & = fit(F_2,F_3) & \mathrm{if}\;fit(F_1,F_3) = {\bf void}\\
fit(F_1 \cup F_2,F_3) & = fit(F_1,F_3) \cup fit(F_2,F_3) & \mathrm{otherwise}\\
fit(F_1,F_2) & = F_1 & \mathrm{if} \; F_1 \subtype F_2 \; \mathrm{and} \; F_2 \subtype F_1\\
fit(F_1,F_2) & = {\bf void} & \mathrm{otherwise}
\end{align*}


